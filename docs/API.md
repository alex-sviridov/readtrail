# ReadTrail Backend API Specification

## Overview

This document specifies the RESTful API expected by the ReadTrail frontend application. The backend should implement these endpoints using Express.js with optional HTTP header authentication.

## Base URL

```
http://localhost:3000/api
```

Configure via environment variable: `VITE_API_BASE_URL`

## Authentication

### Authentication Modes

The backend supports three authentication modes controlled by environment variables:

#### 1. No Authentication Mode
```env
AUTH_ENABLE=false
```
- Single default user, no authentication required
- All requests use a default user account
- No authentication headers needed

#### 2. HTTP Header Authentication Mode
```env
AUTH_ENABLE=true
AUTH_REMOTE_HTTP_HEADER=X-Auth-User
```
- Requires authentication header on all requests
- Header name configurable via `AUTH_REMOTE_HTTP_HEADER`
- Header value should contain user identifier (username, email, etc.)
- Backend creates user account if not exists

#### 3. Guest User Mode
```env
AUTH_ENABLE=true
AUTH_GUEST_USER_ENABLE=true
```
- Allows anonymous usage without authentication
- Guest users can use the app and their data is stored separately
- When guest provides auth header, their data is migrated to authenticated user

### Authentication Headers

When `AUTH_ENABLE=true`, include the authentication header in all requests:

```http
X-Auth-User: user@example.com
```

The header name is configurable via `AUTH_REMOTE_HTTP_HEADER`.

### Response Codes for Authentication

- `200 OK` - Request successful
- `401 Unauthorized` - Authentication required but not provided
- `403 Forbidden` - Authentication provided but invalid

## Data Models

### Book Object

```typescript
{
  id: string,                    // UUID generated by backend
  name: string,                  // Book title (required)
  author: string | null,         // Author name
  coverLink: string | null,      // URL to book cover image
  year: number | null,           // Completion year (null = in progress)
  month: number | null,          // Completion month 1-12 (null = in progress)
  attributes: {
    isUnfinished: boolean,       // Marked as unfinished when completed
    customCover: boolean,        // Whether using custom cover
    score: number | null         // 1 (like), -1 (dislike), 0 (neutral), null (no score)
  },
  createdAt: string,             // ISO 8601 timestamp
  updatedAt: string              // ISO 8601 timestamp (backend-managed)
}
```

### Settings Object

```typescript
{
  showBookInfo: boolean,          // Show book title/author on cards
  allowUnfinishedReading: boolean,// Enable unfinished marking
  allowScoring: boolean,          // Enable book scoring feature
  updatedAt: string               // ISO 8601 timestamp (backend-managed)
}
```

## API Endpoints

### Books

#### List All Books
```http
GET /api/books
```

**Response**: `200 OK`
```json
{
  "books": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "The Great Gatsby",
      "author": "F. Scott Fitzgerald",
      "coverLink": "https://covers.openlibrary.org/b/id/123456-L.jpg",
      "year": 2024,
      "month": 11,
      "attributes": {
        "isUnfinished": false,
        "customCover": false,
        "score": 1
      },
      "createdAt": "2024-11-15T10:30:00Z",
      "updatedAt": "2024-11-15T10:30:00Z"
    }
  ]
}
```

**Error Responses**:
- `401 Unauthorized` - Authentication required
- `500 Internal Server Error` - Server error

---

#### Get Single Book
```http
GET /api/books/:id
```

**Response**: `200 OK`
```json
{
  "book": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "The Great Gatsby",
    ...
  }
}
```

**Error Responses**:
- `404 Not Found` - Book not found
- `401 Unauthorized` - Authentication required

---

#### Create Book
```http
POST /api/books
Content-Type: application/json
```

**Request Body**:
```json
{
  "name": "The Great Gatsby",
  "author": "F. Scott Fitzgerald",
  "coverLink": "https://covers.openlibrary.org/b/id/123456-L.jpg",
  "year": 2024,
  "month": 11,
  "attributes": {
    "isUnfinished": false,
    "customCover": false,
    "score": 1
  }
}
```

**Response**: `201 Created`
```json
{
  "book": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "The Great Gatsby",
    "author": "F. Scott Fitzgerald",
    "coverLink": "https://covers.openlibrary.org/b/id/123456-L.jpg",
    "year": 2024,
    "month": 11,
    "attributes": {
      "isUnfinished": false,
      "customCover": false,
      "score": 1
    },
    "createdAt": "2024-11-15T10:30:00Z",
    "updatedAt": "2024-11-15T10:30:00Z"
  }
}
```

**Error Responses**:
- `400 Bad Request` - Invalid request body (missing required fields)
- `401 Unauthorized` - Authentication required
- `500 Internal Server Error` - Server error

**Validation Rules**:
- `name` is required (non-empty string)
- `year` and `month` must be both null or both set
- `month` must be 1-12 if set
- `attributes.score` must be -1, 0, 1, or null

---

#### Update Book
```http
PUT /api/books/:id
Content-Type: application/json
```

**Request Body**: (partial updates supported)
```json
{
  "name": "The Great Gatsby",
  "author": "F. Scott Fitzgerald",
  "coverLink": "https://covers.openlibrary.org/b/id/123456-L.jpg",
  "year": 2024,
  "month": 12,
  "attributes": {
    "isUnfinished": true,
    "customCover": false,
    "score": 1
  }
}
```

**Response**: `200 OK`
```json
{
  "book": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "The Great Gatsby",
    "author": "F. Scott Fitzgerald",
    "coverLink": "https://covers.openlibrary.org/b/id/123456-L.jpg",
    "year": 2024,
    "month": 12,
    "attributes": {
      "isUnfinished": true,
      "customCover": false,
      "score": 1
    },
    "createdAt": "2024-11-15T10:30:00Z",
    "updatedAt": "2024-12-09T14:20:00Z"
  }
}
```

**Error Responses**:
- `404 Not Found` - Book not found
- `400 Bad Request` - Invalid request body
- `401 Unauthorized` - Authentication required
- `409 Conflict` - Update conflict (see Conflict Resolution below)

---

#### Delete Book
```http
DELETE /api/books/:id
```

**Response**: `204 No Content`

**Error Responses**:
- `404 Not Found` - Book not found
- `401 Unauthorized` - Authentication required

---

#### Batch Create Books (for migration)
```http
POST /api/books/batch
Content-Type: application/json
```

**Request Body**:
```json
{
  "books": [
    {
      "name": "Book 1",
      "author": "Author 1",
      "year": 2024,
      "month": 11,
      ...
    },
    {
      "name": "Book 2",
      "author": "Author 2",
      "year": 2024,
      "month": 10,
      ...
    }
  ]
}
```

**Response**: `201 Created`
```json
{
  "books": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "Book 1",
      ...
    },
    {
      "id": "660e8400-e29b-41d4-a716-446655440001",
      "name": "Book 2",
      ...
    }
  ]
}
```

**Notes**:
- Used for migrating localStorage data to backend
- Creates multiple books in a single transaction
- All books succeed or all fail (atomic operation recommended)

---

### Settings

#### Get Settings
```http
GET /api/settings
```

**Response**: `200 OK`
```json
{
  "settings": {
    "showBookInfo": true,
    "allowUnfinishedReading": true,
    "allowScoring": true,
    "updatedAt": "2024-11-15T10:30:00Z"
  }
}
```

**Error Responses**:
- `404 Not Found` - Settings not found (use defaults)
- `401 Unauthorized` - Authentication required

**Default Values**: If settings don't exist, return:
```json
{
  "settings": {
    "showBookInfo": true,
    "allowUnfinishedReading": true,
    "allowScoring": true,
    "updatedAt": null
  }
}
```

---

#### Update Settings
```http
PUT /api/settings
Content-Type: application/json
```

**Request Body**: (partial updates supported)
```json
{
  "showBookInfo": false,
  "allowUnfinishedReading": true,
  "allowScoring": false
}
```

**Response**: `200 OK`
```json
{
  "settings": {
    "showBookInfo": false,
    "allowUnfinishedReading": true,
    "allowScoring": false,
    "updatedAt": "2024-12-09T14:20:00Z"
  }
}
```

**Error Responses**:
- `400 Bad Request` - Invalid request body
- `401 Unauthorized` - Authentication required

---

### Health Check

#### Health Status
```http
GET /api/health
```

**Response**: `200 OK`
```json
{
  "status": "ok",
  "timestamp": "2024-12-09T14:20:00Z"
}
```

**Notes**:
- No authentication required
- Used by frontend to check backend availability

---

## Conflict Resolution

### Update Conflicts

When the frontend updates a book that has been modified on the backend since the last sync:

**Response**: `409 Conflict`
```json
{
  "error": "Conflict",
  "message": "Book has been modified since last sync",
  "serverVersion": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "The Great Gatsby (Updated)",
    "author": "F. Scott Fitzgerald",
    "updatedAt": "2024-12-09T14:25:00Z",
    ...
  }
}
```

**Frontend Behavior** (Last-Write-Wins):
1. Accept server version as authoritative
2. Update local state with `serverVersion`
3. Discard local changes
4. Optionally notify user of conflict

---

## Error Response Format

All error responses follow this format:

```json
{
  "error": "Error Type",
  "message": "Human-readable error message",
  "details": {} // Optional: Additional error context
}
```

**Common Error Types**:
- `ValidationError` - Invalid request data
- `NotFoundError` - Resource not found
- `AuthenticationError` - Authentication required or failed
- `ConflictError` - Update conflict
- `ServerError` - Internal server error

---

## Rate Limiting

**Recommended Limits**:
- 100 requests per minute per user
- 1000 requests per hour per user

**Response Headers**:
```http
X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1638360000
```

**Rate Limit Exceeded Response**: `429 Too Many Requests`
```json
{
  "error": "RateLimitExceeded",
  "message": "Too many requests, please try again later",
  "retryAfter": 60
}
```

---

## CORS Configuration

The backend should enable CORS for the frontend origin:

```javascript
Access-Control-Allow-Origin: http://localhost:5173
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, X-Auth-User
Access-Control-Max-Age: 86400
```

For development, allow `http://localhost:5173` (Vite default port).

---

## Timestamps

All timestamps should be in ISO 8601 format with UTC timezone:

```
2024-12-09T14:20:00Z
```

The backend automatically manages `createdAt` and `updatedAt` fields.

---

## Database Considerations

### Recommended Schema

**Books Table**:
```sql
CREATE TABLE books (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(255) NOT NULL,
  name VARCHAR(500) NOT NULL,
  author VARCHAR(255),
  cover_link TEXT,
  year INTEGER,
  month INTEGER CHECK (month BETWEEN 1 AND 12),
  attributes JSONB DEFAULT '{"isUnfinished": false, "customCover": false, "score": null}',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  INDEX idx_user_books (user_id),
  INDEX idx_completion (year, month),
  CONSTRAINT year_month_consistency CHECK (
    (year IS NULL AND month IS NULL) OR
    (year IS NOT NULL AND month IS NOT NULL)
  )
);
```

**Settings Table**:
```sql
CREATE TABLE settings (
  user_id VARCHAR(255) PRIMARY KEY,
  show_book_info BOOLEAN DEFAULT true,
  allow_unfinished_reading BOOLEAN DEFAULT true,
  allow_scoring BOOLEAN DEFAULT true,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**Users Table** (if using guest mode):
```sql
CREATE TABLE users (
  id VARCHAR(255) PRIMARY KEY,
  is_guest BOOLEAN DEFAULT false,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

---

## Testing the API

### Example cURL Commands

**List Books** (No Auth):
```bash
curl http://localhost:3000/api/books
```

**List Books** (With Auth):
```bash
curl -H "X-Auth-User: user@example.com" \
     http://localhost:3000/api/books
```

**Create Book**:
```bash
curl -X POST http://localhost:3000/api/books \
     -H "Content-Type: application/json" \
     -H "X-Auth-User: user@example.com" \
     -d '{
       "name": "The Great Gatsby",
       "author": "F. Scott Fitzgerald",
       "year": 2024,
       "month": 11,
       "attributes": {
         "isUnfinished": false,
         "customCover": false,
         "score": 1
       }
     }'
```

**Update Book**:
```bash
curl -X PUT http://localhost:3000/api/books/550e8400-e29b-41d4-a716-446655440000 \
     -H "Content-Type: application/json" \
     -H "X-Auth-User: user@example.com" \
     -d '{
       "year": 2024,
       "month": 12,
       "attributes": {
         "isUnfinished": true,
         "score": 1
       }
     }'
```

**Delete Book**:
```bash
curl -X DELETE http://localhost:3000/api/books/550e8400-e29b-41d4-a716-446655440000 \
     -H "X-Auth-User: user@example.com"
```

**Get Settings**:
```bash
curl -H "X-Auth-User: user@example.com" \
     http://localhost:3000/api/settings
```

**Update Settings**:
```bash
curl -X PUT http://localhost:3000/api/settings \
     -H "Content-Type: application/json" \
     -H "X-Auth-User: user@example.com" \
     -d '{
       "showBookInfo": false,
       "allowScoring": true
     }'
```

---

## Implementation Checklist

- [ ] Set up Express.js server
- [ ] Implement authentication middleware
- [ ] Create database schema
- [ ] Implement Books CRUD endpoints
- [ ] Implement Settings endpoints
- [ ] Implement batch create endpoint
- [ ] Add input validation
- [ ] Add error handling
- [ ] Configure CORS
- [ ] Add rate limiting (optional)
- [ ] Write API tests
- [ ] Add logging
- [ ] Document environment variables
